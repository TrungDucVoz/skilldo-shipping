<?phpif(!function_exists('admin_shipping_ajax_zone_save')) {    function admin_shipping_ajax_zone_save($ci, $model) {        $result['status'] = 'error';        $result['message'] = 'Lưu dữ liệu thất bại';        if(InputBuilder::post()) {            $post = InputBuilder::post();            $zone_id = (int)InputBuilder::post('zone_id');            if( $zone_id == 0 ) {                if($post['zone_name'] != '' && have_posts( $post['zone_locations'] ) || $post['zone_type'] != '') {                    $data['zone_name'] = Str::clear($post['zone_name']);                    $data['zone_type'] = Str::clear($post['zone_type']);                    $model->settable('wcmc_shipping_zones');                    $id = $model->add(['zone_name' => $data['zone_name'],'zone_type' => $data['zone_type']]);                    if( $id != 0 ) {                        $model->settable('wcmc_shipping_zone_locations');                        $zone['zone_id'] 		= $id;                        $zone['location_code']	= 'VN';                        $states = Cart_Location::cities();                        foreach ($post['zone_locations'] as $value) {                            $value = Str::clear($value);                            if( isset($states[$value])) {                                $zone['location_type']	= $value;                                $model->add( $zone );                            }                        }                        $zones = shipping::getsZone();                        ob_start();                        foreach ($zones as $value): ?>                            <tr class="js_shipping_zone__item">                                <td>                                    <?php echo $value->zone_name;?>                                </td>                                <td>                                    <?php foreach ($value->locations as $location): ?>                                        <?php echo $states[$location->location_type];?>                                    <?php endforeach ?>                                </td>                                <td>                                    <?php echo shipping::getZoneType($value->zone_type);?>                                </td>                                <td class="sort">                                    <button class="js_shipping_zone__btn_delete btn-red btn-icon" type="button" data-id="<?php echo $value->id;?>">Xóa</button>                                    <a href="<?php echo Url::admin(sicommerce_cart::url('setting').'&tab=shipping&section='.SHIP_KEY.'&zone_id='.$value->id);?>" class="btn-edit btn-blue btn-icon">Edit</a>                                </td>                            </tr>                        <?php endforeach;                        $result['data'] = ob_get_contents();                        ob_end_clean();                        $result['status'] 	= 'success';                        $result['message'] 	= 'Lưu dữ liệu thành công';                    }                }            }            else {                $zone = shipping::getZone( $zone_id );                if(have_posts($zone)) {                    if(isset($post['zone_name'])) $data['zone_name'] 	= Str::clear($post['zone_name']);                    if(isset($post['zone_type'])) $data['zone_type'] 	= Str::clear($post['zone_type']);                    if(isset($post['zone_price'])) $data['zone_price'] = (int)Str::clear($post['zone_price']);                    $model->settable('wcmc_shipping_zones');                    if($model->update_where( $data, array('id' => $zone_id))) {                        $locations = $post['zone_locations'];                        $model->settable('wcmc_shipping_zone_locations');                        foreach ($zone->locations as $location) {                            if(in_array( $location->location_type, $locations ) === false ) {                                $model->delete_where( array( 'zone_id' => $zone_id, 'location_type' => $location->location_type ));                            } else unset($locations[array_search( $location->location_type, $locations) ]);                        }                        if(have_posts($locations)) {                            $zone_location['zone_id'] 		= $zone_id;                            $zone_location['location_code']	= 'VN';                            foreach ($locations as $value) {                                $zone_location['location_type']	= $value;                                $model->add( $zone_location );                            }                        }                        $result['status'] 	= 'success';                        $result['message'] 	= 'Lưu dữ liệu thành công';                    }                }            }        }        echo json_encode( $result );    }    Ajax::admin( 'admin_shipping_ajax_zone_save' );}if(!function_exists('admin_shipping_ajax_zone_delete')) {    function admin_shipping_ajax_zone_delete( $ci, $model ) {        $result['status'] = 'error';        $result['message'] = 'Xóa dữ liệu thất bại';        if( InputBuilder::post() ) {            $post    = InputBuilder::post();            $zone_id = (int)InputBuilder::post('zone_id');            $zone    = shipping::getZone( $zone_id );            if(have_posts($zone)) {                $model->settable('wcmc_shipping_zones');                if( $model->delete_where( array('id' => $zone_id )) ) {                    //delete zone_locations                    $model->settable('wcmc_shipping_zone_locations');                    $model->delete_where( array('zone_id' => $zone_id ) );                    //delete districts                    $model->settable('wcmc_shipping_districts');                    $districts = $model->gets_where(['zone_id' => $zone_id]);                    $model->settable('wcmc_shipping_districts_locations');                    foreach ($districts as $district) {                        $model->delete_where(['districts_id' => $district->id]);                    }                    $model->settable('wcmc_shipping_districts');                    $model->delete_where(['zone_id' => $zone_id]);                    $result['status'] 	= 'success';                    $result['message'] 	= 'Xóa dữ liệu thành công';                }            }        }        echo json_encode( $result );    }    Ajax::admin( 'admin_shipping_ajax_zone_delete' );}if(!function_exists('admin_shipping_ajax_districts_save')) {    function admin_shipping_ajax_districts_save($ci, $model) {        $result['status'] = 'error';        $result['message'] = 'Lưu dữ liệu thất bại';        if(InputBuilder::post()) {            $post = InputBuilder::post();            if($post['districts_price'] != '' && have_posts( $post['districts_locations'] ) || $post['zone_id'] != '') {                $shipping = Option::get('cart_shipping');                if (!empty($shipping[SHIP_KEY]['range_price']) && $shipping[SHIP_KEY]['range_price'] == 'range_price'){                    $data['districts_price_min'] 	= Str::clear( $post['districts_price_min'] );                    $data['districts_price_max'] 	= Str::clear( $post['districts_price_max'] );                }                $data['zone_id'] 			= (int)Str::clear( $post['zone_id'] );                $data['districts_price'] 	= Str::clear( $post['districts_price'] );                $model->settable('wcmc_shipping_districts');                if(!isset($post['districts_id']) || $post['districts_id'] == 0) {                    $id = $model->add($data);                    if(!empty($id)) {                        $model->settable('wcmc_shipping_districts_locations');                        $districts_locations['districts_id'] 		= $id;                        $districts = Cart_Location::districts();                        foreach ($post['districts_locations'] as $value) {                            $value = explode('_', Str::clear($value) );                            $districts_locations['locations_type']	= $value[0];                            $districts_locations['locations_code']	= $value[1];                            if(isset($districts[$districts_locations['locations_type']][$districts_locations['locations_code']])) {                                $model->add($districts_locations);                            }                        }                        $model->settable('wcmc_shipping_districts');                        $zone_districts = $model->get_where( array('id' => $id ));                        $zone_districts->locations = shipping::getsDistrictsLocations( array('where' => array('districts_id' => $id)));                        ob_start(); ?>                        <tr class="js_shipping_districts__item">                            <td>                                <?php                                $zone = shipping::getZone( $data['zone_id'] );                                $locations = array();                                foreach ($zone->locations as $value) {                                    $locations[$value->location_type] = $value;                                }                                $states 	= Cart_Location::cities();                                $districts 	= Cart_Location::districts();                                $districts_option = array();                                foreach ($locations as $key =>$location):                                    foreach ($districts[$key] as $key_districts => $name_districts):                                        $districts_option[$key.'_'.$key_districts] = $name_districts;                                    endforeach;                                endforeach;                                $districts_locations = array();                                foreach ($zone_districts->locations as $location) {                                    $districts_locations[$location->locations_type.'_'.$location->locations_code] = $location;                                }                                ?>                                <select class="form-control zone_locations-multiple" name="zone_districts[<?php echo $zone_districts->id;?>][locations]" multiple>                                    <?php foreach ($districts_option as $key_districts => $name_districts): ?>                                        <option value="<?php echo $key_districts;?>" <?php echo ( isset($districts_locations[$key_districts]) )?'selected=selected':'';?>><?php echo $name_districts;?></option>                                    <?php endforeach ?>                                </select>                            </td>                            <?php if (!empty($shipping[SHIP_KEY]['range_price']) && $shipping[SHIP_KEY]['range_price'] == 'range_price'){ ?>                                <td>                                    <input type="number" class="form-control" value="<?php echo $zone_districts->districts_price_min;?>" name="zone_districts[<?php echo $zone_districts->id;?>][min]">                                </td>                                <td>                                    <input type="number" class="form-control" value="<?php echo $zone_districts->districts_price_max;?>" name="zone_districts[<?php echo $zone_districts->id;?>][max]">                                </td>                            <?php } ?>                            <td>                                <input type="number" class="form-control" value="<?php echo $zone_districts->districts_price;?>" name="zone_districts[<?php echo $zone_districts->id;?>][price]">                            </td>                            <td class="sort">                                <button class="js_zone_districts__delete btn-red btn-icon" data-id="<?php echo $zone_districts->id;?>">Xóa</button>                                <button class="js_zone_districts__edit btn-blue btn-icon" data-id="<?php echo $zone_districts->id;?>">Lưu</button>                            </td>                        </tr>                        <?php                        $result['data'] = ob_get_contents();                        ob_end_clean();                        $result['status'] 	= 'success';                        $result['message'] 	= 'Lưu dữ liệu thành công';                    }                }                else {                    $id = (int)$post['districts_id'];                    $data['districts_price'] 	= Str::clear( $post['districts_price'] );                    $model->settable('wcmc_shipping_districts');                    $model->update_where( $data, array('id' => $id) );                    $model->settable('wcmc_shipping_districts_locations');                    $model->delete_where( array('districts_id' => $id) );                    $districts = Cart_Location::districts();                    $districts_locations['districts_id'] 		= $id;                    foreach ($post['districts_locations'] as $value) {                        $value = explode('_', Str::clear($value) );                        $districts_locations['locations_type']	= $value[0];                        $districts_locations['locations_code']	= $value[1];                        if( isset($districts[$districts_locations['locations_type']][$districts_locations['locations_code']])) {                            $model->add($districts_locations);                        }                    }                    $result['type'] 	= 'success';                    $result['message'] 	= 'Lưu dữ liệu thành công';                }            }        }        echo json_encode( $result );    }    Ajax::admin( 'admin_shipping_ajax_districts_save' );}if(!function_exists('admin_shipping_ajax_districts_delete')) {    function admin_shipping_ajax_districts_delete( $ci, $model ) {        $result['status'] = 'error';        $result['message'] = 'Xóa dữ liệu thất bại';        if( InputBuilder::post() ) {            $post = InputBuilder::post();            $id = (int)$post['districts_id'];            $model->settable('wcmc_shipping_districts');            if( $model->delete_where( array('id' => $id) ) ) {                $model->settable('wcmc_shipping_districts_locations');                $model->delete_where( array('districts_id' => $id) );                $result['status'] 	= 'success';                $result['message'] 	= 'Xóa dữ liệu thành công';            }        }        echo json_encode( $result );    }    Ajax::admin( 'admin_shipping_ajax_districts_delete' );}